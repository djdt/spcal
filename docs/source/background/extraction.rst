Extraction of compound-Poisson-lognormal parameters
===================================================

Data generated by an ICP-TOF is non-integer due to a lack of a pulse counting mode, see :ref:`spICP-ToF: Compound-Poisson` for more information. This complicates determination of a :term:`detection threshold` as we cannot use the normal Poisson or Gaussian statistics.
Closely approximating the signal produced by a TOF using a compound-Poisson-lognormal distribution allows the use of our :ref:`approximation<Log-normal approximation>` and :ref:`lookup table<Lookup Table>` methods.
However, both of these approaches require some knowledge of the underlying distribution, including the shape parameter (:math:`\sigma`) of the lognormal part.


Method
------

Drawing a value from a compound-Poisson-lognormal distribution is performed by taking :math:`N` samples from a lognormal and summing them, where the value of :math:`N` is drawn from a Poisson.


.. math::

   Y &= \sum_{i=0}^{N} lognormal(\mu, \sigma) \\
   N &\sim Poisson(\lambda)

As the lognormal cannot produce zeros, we know that all zeros in the data must come from the Poisson portion of the compound distribution. We can use this knowledge to calculate :math:`\lambda` from the fraction of zeros, using the Poisson mass probability function.

.. math::
   
    \lambda = -\log{P(Y=0)}

We can then use the laws of total expectation and variance to calculate expected values of the lognormal portion using the mean and variance of the data.

.. math::
   E[X] &= \frac{E[Y]}{\lambda} \\
   E[X^2] &= \frac{V[Y]}{\lambda}


Finally we can recover the lognormal parmaters :math:`\mu` and :math:`\sigma` using their method of moments.

.. math::
   \mu &= \log{\frac{E[X]^2}{\sqrt{E[X^2]}}} \\
   \sigma &= \sqrt{\log{\frac{E[X^2]}{E[X]^2}}}


Automatic calculation of SIA shape in SPCal
-------------------------------------------

The above method can be used to extract the shape parameter from data loaded into SPCal, eliminating the need toi measure it separately and providing a per-mass shape.
Checking the *Automatic* checkbox next to the *SIA Ïƒ* option will enable automatic extraction for data detected as compound-Poisson.

.. warn::

   Extraction of compound-Poisson-lognormal parameters requires a sufficient number of non-zero values. For data with a very low mean the extracted shape may be inaccurate.
